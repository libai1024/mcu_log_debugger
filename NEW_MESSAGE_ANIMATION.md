# 新消息动画效果说明

## 🎨 动画设计

### 基础动画效果
新消息进入时会有以下视觉效果：
1. **淡入**：从 0% 不透明度渐变到 100%
2. **滑入**：从左侧 -20px 滑动到正常位置
3. **背景高亮**：短暂显示彩色背景，然后淡出
4. **左侧边框**：不同日志级别显示不同颜色的左侧边框（仅在动画期间）

### 动画时长
- **总时长**：400ms
- **缓动函数**：`cubic-bezier(0.16, 1, 0.3, 1)` - 平滑弹性效果
- **标记清除**：动画结束后自动移除 `new-entry` 类

## 🎯 不同级别的动画效果

### 默认（VERBOSE/DEBUG/其他）
- **背景色**：浅蓝色 `rgba(59, 130, 246, 0.15)`
- **淡出到**：透明
- **适用于**：普通日志消息

### INFO 级别
- **背景色**：浅绿色 `rgba(16, 185, 129, 0.15)`
- **左侧边框**：绿色 `var(--level-info-fg)`
- **效果**：积极、正面的视觉反馈

### WARN 级别
- **背景色**：浅黄色 `rgba(251, 191, 36, 0.2)`
- **左侧边框**：黄色 `var(--level-warn-fg)`
- **效果**：引起注意但不过于突兀

### ERROR 级别
- **背景色**：浅红色 `rgba(239, 68, 68, 0.2)`
- **左侧边框**：红色 `var(--level-error-fg)`
- **效果**：强烈的警示效果，吸引用户注意

## 🔧 技术实现

### 1. 标记机制
```javascript
// 在批量处理时标记新消息
toAdd.forEach((entry, i) => { 
    entry.index = allEntries.length + i;
    entry.isNew = true; // 标记为新消息
});

// 400ms 后移除标记
setTimeout(() => {
    toAdd.forEach(entry => { entry.isNew = false; });
}, 400);
```

### 2. CSS 类应用
```javascript
const newClass = entry.isNew ? 'new-entry' : '';
// 添加到 log-row 类名中
<tr class="log-row ... ${newClass}">
```

### 3. 动画样式
```css
.log-row.new-entry {
    animation: newEntrySlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

/* 不同级别的特定动画 */
.log-row.new-entry.level-ERROR { animation: newEntrySlideInError ... }
.log-row.new-entry.level-WARN { animation: newEntrySlideInWarn ... }
.log-row.new-entry.level-INFO { animation: newEntrySlideInInfo ... }
```

## 🎬 动画阶段详解

### 阶段 1：进入 (0%)
- 透明度：0（完全透明）
- 位置：-20px（左侧偏移）
- 背景：级别对应的高亮色（最亮）
- 边框：4px 左侧彩色边框

### 阶段 2：中间 (50%)
- 背景：渐变到 50% 透明度
- 边框：开始淡出

### 阶段 3：完成 (100%)
- 透明度：1（完全可见）
- 位置：0（正常位置）
- 背景：完全透明
- 边框：无

## 🌟 用户体验优势

### 1. 视觉反馈
- 用户可以清楚地看到新消息的到来
- 不会错过重要的 ERROR 或 WARN 消息

### 2. 流畅过渡
- 平滑的缓动函数确保动画不会突兀
- 400ms 的时长既能吸引注意又不会造成干扰

### 3. 级别区分
- 不同级别的消息有不同的视觉强度
- ERROR 消息更加醒目，VERBOSE 消息较为柔和

### 4. 性能优化
- 使用 CSS 动画而非 JavaScript，性能更好
- 动画结束后自动清理状态，不影响后续操作

## 📊 适用场景

### 生效条件
- ✅ 新消息通过批量处理添加到日志列表
- ✅ 消息在可视区域内（虚拟滚动的最近 300 条）
- ✅ 视图未锁定或锁定状态下仍会渲染

### 不生效条件
- ❌ 首次加载历史消息
- ❌ 过滤器改变导致的重新渲染
- ❌ 模式切换导致的重新渲染
- ❌ 手动刷新/清空后重新渲染

## 🎮 测试方法

### 快速测试
1. 连接虚拟串口
2. 启动日志模拟器
3. 观察新消息的滑入效果
4. 注意不同级别消息的颜色差异

### 详细测试
```bash
# 1. 启动虚拟串口
socat -d -d pty,raw,echo=0 pty,raw,echo=0

# 2. 连接应用到虚拟串口

# 3. 启动模拟器（连续模式）
python3 test_log_simulator.py --port /dev/ttys??? --scenario continuous

# 4. 观察以下效果：
# - VERBOSE/DEBUG 消息：浅蓝色淡入
# - INFO 消息：浅绿色淡入 + 绿色左边框
# - WARN 消息：浅黄色淡入 + 黄色左边框
# - ERROR 消息：浅红色淡入 + 红色左边框
```

## 🔄 三种模式支持

动画效果在所有三种显示模式下都生效：

### Log 模式
- ✅ 完整动画效果
- ✅ 级别颜色区分
- ✅ 结构化显示

### HEX 模式
- ✅ 基础动画效果
- ✅ 不区分级别颜色（HEX 模式无级别概念）
- ✅ 十六进制数据滑入

### Normal 模式
- ✅ 基础动画效果
- ✅ 不区分级别颜色（Normal 模式无级别概念）
- ✅ 原始文本滑入

## 💡 设计理念

### 1. 非侵入式
- 动画柔和，不会打断用户操作
- 短暂的视觉反馈后恢复正常

### 2. 信息层级
- 重要消息（ERROR）动画更醒目
- 普通消息（VERBOSE）动画较为柔和

### 3. 性能优先
- 使用 CSS3 硬件加速
- 避免 JavaScript 动画带来的性能开销
- 批量处理减少渲染次数

### 4. 一致性
- 所有模式使用相同的动画时长
- 缓动函数保持一致
- 视觉效果统一

---

**实现版本**：v1.0.1  
**动画引擎**：CSS3 Animation  
**浏览器兼容**：现代浏览器（Chrome 90+、Firefox 88+、Safari 14+）
